<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>Open Chat ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .info {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 13px;
      line-height: 1.5;
    }
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      box-sizing: border-box;
      min-height: 100px;
    }
    button {
      width: 100%;
      padding: 12px;
      background: #06c755;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 8px;
    }
    button:hover {
      background: #05a847;
    }
    button:active {
      background: #048a3a;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
    }
    .debug {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h1>
      
      <div class="info" id="infoMessage">
        ğŸ“± ç’°å¢ƒã‚’ç¢ºèªä¸­...
      </div>

      <textarea id="messageText" placeholder="é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
      
      <button id="sendButton" onclick="sendMessage()" disabled>é€ä¿¡</button>
      <button id="copyButton" onclick="copyToClipboard()" style="background: #888; display: none;">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
      
      <div id="status"></div>
      <div id="debug" class="debug" style="display: none;"></div>
    </div>

    <script>
    let liffContext = null;
    let canUseSendMessages = false;
    let canUseShareTargetPicker = false;

    // LIFFåˆæœŸåŒ–
    async function initLIFF() {
      try {
        await liff.init({
          liffId: '2008484224-QG93kNNb'
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // ç’°å¢ƒæƒ…å ±ã‚’å–å¾—
        liffContext = liff.getContext();
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        showDebug();

        // æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
        checkAvailableFeatures();

      } catch (err) {
        showStatus('LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
      }
    }

    // åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã‚’ãƒã‚§ãƒƒã‚¯
    function checkAvailableFeatures() {
      const context = liffContext;
      
      // sendMessagesãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      canUseSendMessages = (
        liff.isInClient() &&
        context.type !== 'external' &&
        context.type !== 'none' &&
        liff.isApiAvailable('shareTargetPicker')
      );

      // shareTargetPickerãŒä½¿ãˆã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      canUseShareTargetPicker = liff.isApiAvailable('shareTargetPicker');

      // ç’°å¢ƒã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      let infoMsg = '';
      let sendButtonText = 'é€ä¿¡';
      
      if (context.type === 'utou') {
        infoMsg = 'âœ… 1å¯¾1ãƒˆãƒ¼ã‚¯ç’°å¢ƒã§ã™ã€‚ç›´æ¥é€ä¿¡ã§ãã¾ã™ã€‚';
        canUseSendMessages = true;
      } else if (context.type === 'group') {
        infoMsg = 'âœ… ã‚°ãƒ«ãƒ¼ãƒ—ãƒˆãƒ¼ã‚¯ç’°å¢ƒã§ã™ã€‚ç›´æ¥é€ä¿¡ã§ãã¾ã™ã€‚';
        canUseSendMessages = true;
      } else if (context.type === 'room') {
        infoMsg = 'âœ… è¤‡æ•°äººãƒˆãƒ¼ã‚¯ç’°å¢ƒã§ã™ã€‚ç›´æ¥é€ä¿¡ã§ãã¾ã™ã€‚';
        canUseSendMessages = true;
      } else if (context.type === 'external' || context.type === 'none') {
        if (canUseShareTargetPicker) {
          infoMsg = 'â„¹ï¸ Open Chatç’°å¢ƒã§ã™ã€‚é€ä¿¡å…ˆã‚’é¸æŠã™ã‚‹æ–¹å¼ã§é€ä¿¡ã—ã¾ã™ã€‚';
          sendButtonText = 'ğŸ“¤ é€ä¿¡å…ˆã‚’é¸æŠ';
        } else {
          infoMsg = 'âš ï¸ ã“ã®ç’°å¢ƒã§ã¯è‡ªå‹•é€ä¿¡ã§ãã¾ã›ã‚“ã€‚ã‚³ãƒ”ãƒ¼ã—ã¦æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚';
          document.getElementById('copyButton').style.display = 'block';
        }
      }

      document.getElementById('infoMessage').innerHTML = infoMsg;
      document.getElementById('sendButton').textContent = sendButtonText;
      document.getElementById('sendButton').disabled = false;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async function sendMessage() {
      const message = document.getElementById('messageText').value.trim();
      
      if (!message) {
        showStatus('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const messageData = [{
        type: 'text',
        text: message
      }];

      try {
        // ç›´æ¥é€ä¿¡ãŒå¯èƒ½ãªç’°å¢ƒ
        if (canUseSendMessages && (liffContext.type === 'utou' || liffContext.type === 'group' || liffContext.type === 'room')) {
          await liff.sendMessages(messageData);
          showStatus('âœ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');
          document.getElementById('messageText').value = '';
        }
        // ã‚·ã‚§ã‚¢ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ”ãƒƒã‚«ãƒ¼ã‚’ä½¿ç”¨
        else if (canUseShareTargetPicker) {
          const result = await liff.shareTargetPicker(messageData);
          if (result) {
            showStatus('âœ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');
            document.getElementById('messageText').value = '';
          } else {
            showStatus('é€ä¿¡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'warning');
          }
        }
        // ã©ã¡ã‚‰ã‚‚ä½¿ãˆãªã„å ´åˆ
        else {
          showStatus('ã“ã®ç’°å¢ƒã§ã¯è‡ªå‹•é€ä¿¡ã§ãã¾ã›ã‚“ã€‚ã€Œã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', 'warning');
          document.getElementById('copyButton').style.display = 'block';
        }
      } catch (err) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
        showStatus('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err.message + ' (Code: ' + (err.code || 'unknown') + ')', 'error');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿æ¡ˆã‚’æç¤º
        if (err.code === 403 || err.code === 'FORBIDDEN') {
          showStatus('âš ï¸ ã“ã®ç’°å¢ƒã§ã¯è‡ªå‹•é€ä¿¡ã§ãã¾ã›ã‚“ã€‚ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚', 'warning');
          document.getElementById('copyButton').style.display = 'block';
        }
      }
    }

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
    async function copyToClipboard() {
      const message = document.getElementById('messageText').value.trim();
      
      if (!message) {
        showStatus('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      try {
        await navigator.clipboard.writeText(message);
        showStatus('âœ“ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nOpen Chatã«æˆ»ã£ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'success');
      } catch (err) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const textarea = document.getElementById('messageText');
        textarea.select();
        try {
          document.execCommand('copy');
          showStatus('âœ“ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nOpen Chatã«æˆ»ã£ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„', 'success');
        } catch (e) {
          showStatus('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      }
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
    }

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
    function showDebug() {
      const debugInfo = {
        type: liffContext.type,
        userId: liffContext.userId ? '(å–å¾—æ¸ˆã¿)' : '(ãªã—)',
        isInClient: liff.isInClient(),
        isLoggedIn: liff.isLoggedIn(),
        canUseSendMessages: canUseSendMessages,
        canUseShareTargetPicker: liff.isApiAvailable('shareTargetPicker'),
        os: liff.getOS(),
        language: liff.getLanguage(),
        version: liff.getVersion(),
        lineVersion: liff.getLineVersion()
      };

      const debugElement = document.getElementById('debug');
      debugElement.textContent = JSON.stringify(debugInfo, null, 2);
      debugElement.style.display = 'block';
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆæœŸåŒ–
    window.addEventListener('load', initLIFF);
    </script>
  </body>
</html>
